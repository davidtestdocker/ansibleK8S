name: CI-CD to GKE Autopilot (Terraform + Ansible)

on:
  push:
    branches: [ "master" ]

env:
  IMAGE_TAG: ${{ github.sha }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1️⃣ 認證 Google Cloud
      - name: Set up Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          export_environment_variables: true

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      # 2️⃣ 取得 GKE API endpoint + CA + token（自動）
      - name: Fetch cluster endpoint / CA / token
        id: gke
        run: |
          ENDPOINT=$(gcloud container clusters describe $CLUSTER_NAME \
            --project $PROJECT_ID --region $REGION \
            --format="value(endpoint)")

          CA_CERT=$(gcloud container clusters describe $CLUSTER_NAME \
            --project $PROJECT_ID --region $REGION \
            --format="value(masterAuth.clusterCaCertificate)")

          ACCESS_TOKEN=$(gcloud auth print-access-token)

          echo "ENDPOINT=$ENDPOINT" >> $GITHUB_ENV
          echo "CA_CERT=$CA_CERT" >> $GITHUB_ENV
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      # 3️⃣ 用 token 建立 kubeconfig（不使用 gcloud get-credentials）
      - name: Write kubeconfig
        run: |
          mkdir -p $HOME/.kube
          cat <<EOF > $HOME/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - name: gke
            cluster:
              certificate-authority-data: ${CA_CERT}
              server: https://${ENDPOINT}
          users:
          - name: gke-user
            user:
              token: ${ACCESS_TOKEN}
          contexts:
          - name: gke-context
            context:
              cluster: gke
              user: gke-user
          current-context: gke-context
          EOF

      - name: Debug kubeconfig
        run: |
          echo "=== KUBECONFIG ==="
          cat $HOME/.kube/config

      # 4️⃣ Artifact Registry login
      - name: Docker auth
        run: |
          gcloud --quiet auth configure-docker $REGION-docker.pkg.dev

      # 5️⃣ Build & Push 3 images
      - name: Build and Push images
        run: |
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-client:$IMAGE_TAG ./client
          docker push    $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-client:$IMAGE_TAG

          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-server:$IMAGE_TAG ./server
          docker push    $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-server:$IMAGE_TAG

          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-worker:$IMAGE_TAG ./worker
          docker push    $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/multi-worker:$IMAGE_TAG

      # 6️⃣ Install Ansible + Kubernetes modules
      - name: Install Ansible
        run: |
          pip install --upgrade pip
          pip install ansible kubernetes openshift pyyaml
          ansible-galaxy collection install kubernetes.core

      # 7️⃣ Run Ansible deploy
      - name: Run Ansible deploy
        working-directory: ./ansible
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          ARTIFACT_REPO: ${{ env.ARTIFACT_REPO }}
          KUBECONFIG: $HOME/.kube/config
        run: |
          ansible-playbook -i inventory deploy-all.yaml

