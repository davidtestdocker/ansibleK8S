---
- name: Deploy full multi-service stack to GKE
  hosts: localhost
  gather_facts: no

  # 強制指定 kubeconfig 給 kubernetes.core.k8s
  environment:
    KUBECONFIG: "{{ lookup('env','HOME') }}/.kube/config"

  vars:
    project_id: "{{ lookup('env','PROJECT_ID') }}"
    region: "{{ lookup('env','REGION') }}"
    cluster_name: "{{ lookup('env','CLUSTER_NAME') }}"
    image_tag: "{{ lookup('env','IMAGE_TAG') }}"
    artifact_repo: "{{ lookup('env','ARTIFACT_REPO') }}"
    namespace: "multi-app"

  tasks:

    # -----------------------------------------------------
    # (Debug Step) — 確認 gcloud 是否真的登入成功
    # -----------------------------------------------------
    - name: Debug gcloud auth
      ansible.builtin.command: gcloud auth list
      changed_when: false

    # -----------------------------------------------------
    # (1) 初始化 kubeconfig（一定要第一個）
    # -----------------------------------------------------
    - name: Get GKE credentials
      ansible.builtin.command: >
        gcloud container clusters get-credentials {{ cluster_name }}
        --region {{ region }}
        --project {{ project_id }}
      changed_when: false

    # -----------------------------------------------------
    # (Debug Step) — 確認 kubeconfig 是否成功寫入
    # -----------------------------------------------------
    - name: Debug kubeconfig
      ansible.builtin.command: cat ~/.kube/config
      changed_when: false

    # -----------------------------------------------------
    # (2) Namespace
    # -----------------------------------------------------
    - name: Ensure namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"

    # -----------------------------------------------------
    # (3) Import tasks (依順序)
    # -----------------------------------------------------
    - name: Deploy PVC
      import_tasks: tasks/deploy-pvc.yaml

    - name: Deploy PostgreSQL
      import_tasks: tasks/deploy-postgres.yaml

    - name: Deploy Redis
      import_tasks: tasks/deploy-redis.yaml

    - name: Deploy Server
      import_tasks: tasks/deploy-server.yaml

    - name: Deploy Worker
      import_tasks: tasks/deploy-worker.yaml

    - name: Deploy Client
      import_tasks: tasks/deploy-client.yaml

